import{$ as e,r as s,ad as a,j as t,f as r,e as n}from"./index-epAGByur.js";import"./vendor-MJHYApCa.js";r.locale("ar");const d=()=>{const{friendId:d}=e(),[i,l]=s.useState([]),[c,o]=s.useState(""),[m,u]=s.useState({currentPage:1,totalPages:1}),[g,h]=s.useState(null),[p,j]=s.useState(null),[x,v]=s.useState(!1),[f,_]=s.useState(null),[I,S]=s.useState(""),[N,y]=s.useState(!1),[w,b]=s.useState(null),A=localStorage.getItem("token"),[P,$]=s.useState(""),[C,k]=s.useState((e=>{if(!e)return null;return JSON.parse(atob(e.split(".")[1])).userId})(A));s.useEffect((()=>{(async()=>{try{if(C){const e=await n.get(`https://padel-hnj9.onrender.com/api/user/${C}`,{headers:{Authorization:`Bearer ${A}`}});$(e.data.name)}}catch(e){}})()}),[C]),s.useEffect((()=>{if(!C)return;const e=a("https://padel-hnj9.onrender.com",{query:{userId:C}});return b(e),e.on("receive_message",(e=>{e.senderId!==C&&l((s=>{if(s.some((s=>s._id===e._id)))return s;return s.some((s=>s._id===e._id))?s:[{_id:e._id,senderId:e.senderId,receiverId:e.receiverId,message:e.message,createdAt:e.createdAt,sender:{name:e.senderName}}]}))})),e.on("message_edited",(e=>{l((s=>s.map((s=>s._id===e.messageId?{...s,message:e.newMessage,edited:!0}:s))))})),e.on("message_deleted",(e=>{l((s=>s.filter((s=>s._id!==e.messageId))))})),()=>{e&&e.off("receive_message")}}),[C]),s.useEffect((()=>{(async()=>{if(d)try{v(!0);const e=await n.get(`https://padel-hnj9.onrender.com/api/messages/${d}?page=${m.currentPage}&limit=5`,{headers:{Authorization:`Bearer ${A}`}});l((s=>[...Array.isArray(e.data.messages)?e.data.messages:[],...s])),u({currentPage:e.data.currentPage,totalPages:e.data.totalPages}),v(!1)}catch(e){v(!1)}})()}),[d,m.currentPage]);return t.jsx("div",{className:"messages-container-chat",children:t.jsxs("div",{className:"chat-page",children:[t.jsx("div",{className:"messages",children:0===i.length?t.jsx("p",{children:"لا يوجد رسائل"}):[...i].reverse().map((e=>t.jsxs("div",{className:"message",onClick:()=>{return s=e._id,void j(s);var s},children:[t.jsxs("p",{children:[t.jsx("strong",{className:"sender",children:e.sender._id===C?"انا":e.sender.name})," ",e.message]}),t.jsx("p",{className:"reply",children:e.replyTo&&t.jsxs(t.Fragment,{children:["رد على: ",e.replyTo.message]})}),t.jsxs("p",{className:"timestamp",children:[r(e.createdAt).locale("ar").format("hh:mm A"),e.edited&&t.jsx("span",{className:"edited-indicator",children:"(تم التعديل)"})]}),C===e.sender._id&&p===e._id&&t.jsxs("div",{className:"message-options",children:[t.jsx("button",{onClick:()=>(async e=>{try{200===(await n.delete(`https://padel-hnj9.onrender.com/api/delete/${e}`,{headers:{Authorization:`Bearer ${A}`}})).status&&(l((s=>s.filter((s=>s._id!==e)))),j(null)),w.emit("delete_message",{messageId:e,senderId:C,receiverId:d})}catch(s){}})(e._id),children:"حذف"}),t.jsx("button",{onClick:()=>{_(e._id),S(e.message),j(null)},children:"تعديل"})]})]},e._id)))}),t.jsxs("div",{className:"load-more",children:[!x&&m.currentPage<m.totalPages&&t.jsx("button",{onClick:()=>{u((e=>({...e,currentPage:e.currentPage+1})))},children:"تحميل المزيد"}),x&&t.jsx("p",{children:"جاري التحميل"})]}),f&&t.jsxs("div",{className:"edit-message-form",children:[t.jsx("textarea",{className:"edit-message-textarea",value:I,onChange:e=>S(e.target.value),placeholder:"اكتب الرسالة الجديدة هنا"}),t.jsx("button",{className:"edit-message-button",onClick:()=>(async(e,s)=>{try{const a=localStorage.getItem("token");200===(await n.put(`https://padel-hnj9.onrender.com/api/edit-message/${e}`,{content:s},{headers:{Authorization:`Bearer ${a}`}})).status&&(l((a=>a.map((a=>a._id===e?{...a,message:s,edited:!0}:a)))),w.emit("edit_message",{messageId:e,newMessage:s}))}catch(a){}})(f,I),children:"حفظ"}),t.jsx("button",{className:"cancel-edit-button-chat",onClick:()=>_(null),children:"الغاء"})]}),t.jsxs("form",{onSubmit:async e=>{e.preventDefault();try{w.emit("send_message",{senderId:C,receiverId:d,senderName:P,message:c,replyTo:g,createdAt:(new Date).toISOString()}),l((e=>[...e,{_id:(new Date).toISOString(),senderId:C,receiverId:d,message:c,createdAt:(new Date).toISOString(),sender:{name:P}}])),y(!0),o(""),h(null)}catch(s){}},className:"message-form",children:[t.jsx("input",{className:"message-input",type:"text",value:c,onChange:e=>o(e.target.value),placeholder:"اكتب رسالتك هنا"}),t.jsx("button",{type:"submit",className:"send-button-chat "+(c?"active":"disabled"),disabled:!c,children:t.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"24",height:"24",children:[t.jsx("path",{fill:"none",d:"M0 0h24v24H0z"}),t.jsx("path",{fill:"currentColor",d:"M2 21l21-9-21-9v6l15 3-15 3z"})]})})]})]})})};export{d as default};
